name: Build And Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  bump_version:
    if: ${{ github.event_name == 'workflow_dispatch' || !contains(github.event.head_commit.message, '[skip release]') }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      tag: ${{ steps.bump.outputs.tag }}
      commit_sha: ${{ steps.commit.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Bump patch version
        id: bump
        run: |
          NEXT_VERSION=$(node - <<'NODE'
          const fs = require('fs');
          const pkgPath = 'package.json';
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
          const match = /^(\d+)\.(\d+)\.(\d+)$/.exec(pkg.version);
          if (!match) {
            throw new Error(`Unsupported version format: ${pkg.version}`);
          }
          const next = `${match[1]}.${match[2]}.${Number(match[3]) + 1}`;
          pkg.version = next;
          fs.writeFileSync(pkgPath, `${JSON.stringify(pkg, null, 2)}\n`);
          process.stdout.write(next);
          NODE
          )
          echo "version=${NEXT_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${NEXT_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Commit, tag and push
        id: commit
        run: |
          git add package.json
          git commit -m "chore(release): bump version to ${{ steps.bump.outputs.version }} [skip release]"
          git tag "${{ steps.bump.outputs.tag }}"
          git push origin "HEAD:${{ github.ref_name }}"
          git push origin "${{ steps.bump.outputs.tag }}"
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  build_mac:
    needs: bump_version
    runs-on: macos-latest
    steps:
      - name: Checkout tagged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump_version.outputs.commit_sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --config.node-linker=hoisted

      - name: Build mac package
        run: pnpm run package:mac

      - name: Upload mac artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-artifacts
          if-no-files-found: error
          path: |
            release/*.dmg
            release/*.dmg.blockmap
            release/*-mac.yml

  build_win:
    needs: bump_version
    runs-on: windows-latest
    steps:
      - name: Checkout tagged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump_version.outputs.commit_sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --config.node-linker=hoisted

      - name: Force npm_execpath to pnpm.cmd
        shell: pwsh
        run: |
          $pnpmCmd = (Get-Command pnpm.cmd).Source
          "npm_execpath=$pnpmCmd" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Using npm_execpath: $pnpmCmd"

      - name: Build windows package
        run: |
          pnpm run build
          pnpm exec electron-builder --win nsis --publish never

      - name: Upload windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win-artifacts
          if-no-files-found: error
          path: |
            release/*.exe
            release/*.exe.blockmap
            release/latest.yml

  build_linux:
    needs: bump_version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tagged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump_version.outputs.commit_sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --config.node-linker=hoisted

      - name: Build linux package (amd64)
        run: pnpm run package:linux

      - name: Upload linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          if-no-files-found: error
          path: |
            release/*.AppImage

  create_release:
    needs:
      - bump_version
      - build_mac
      - build_win
      - build_linux
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -R artifacts

      - name: Publish Existing Draft Release If Needed
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = '${{ needs.bump_version.outputs.tag }}';

            try {
              const { data: release } = await github.rest.repos.getReleaseByTag({
                owner,
                repo,
                tag,
              });

              if (release.draft || release.prerelease) {
                await github.rest.repos.updateRelease({
                  owner,
                  repo,
                  release_id: release.id,
                  tag_name: tag,
                  name: `Release ${tag}`,
                  draft: false,
                  prerelease: false,
                });
              }
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }
            }

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.bump_version.outputs.tag }}
          name: Release ${{ needs.bump_version.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/mac-artifacts/*.dmg
            artifacts/mac-artifacts/*.dmg.blockmap
            artifacts/mac-artifacts/*-mac.yml
            artifacts/win-artifacts/*.exe
            artifacts/win-artifacts/*.exe.blockmap
            artifacts/win-artifacts/latest.yml
            artifacts/linux-artifacts/*.AppImage
          overwrite_files: true
          fail_on_unmatched_files: true
